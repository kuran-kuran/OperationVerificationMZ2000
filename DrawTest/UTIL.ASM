; ユーティリティ関数
; 基本レジスタ破壊を気にしない

; 8ビット同士の掛け算
; BC = B * E
MUL_BE:
	PUSH	AF
	PUSH	HL
	LD	HL, 0
	LD	C, 0
	SRL	B
	RR	C
	LD	A, 8
MUL_BE_L1:
	SLA	E
	JR	NC, MUL_BE_L2
	ADD	HL, BC
MUL_BE_L2:
	SRL	B
	RR	C
	DEC	A
	JR	NZ, MUL_BE_L1
	LD	C, L
	LD	B, H
	POP	HL
	POP	AF
	RET

; HL = HL + A
ADD_HL_A:
	ADD	A, L
	LD	L, A
	JR	NC, ADD_HL_A_L1
	INC	H
ADD_HL_A_L1:
	RET

; HL = HL * 12
MUL_HLx12:
	ADD	HL, HL ; *2
	ADD	HL, HL ; *4
	LD	B, H
	LD	C, L
	ADD	HL, HL ; *8
	ADD	HL, BC
	RET

; HL = HL * 14
MUL_HLx14:
	ADD	HL, HL ; *2
	LD	B, H
	LD	C, L
	ADD	HL, HL ; *4
	ADD	HL, HL ; *8
	ADD	HL, BC
	ADD	HL, BC
	ADD	HL, BC
	RET

; HL = HL * 24
MUL_HLx24:
	ADD	HL, HL ; *2
	ADD	HL, HL ; *4
	ADD	HL, HL ; *8
	LD	B, H
	LD	C, L
	ADD	HL, HL ; *16
	ADD	HL, BC
	RET

; HL = HL * 28
MUL_HLx28:
	ADD	HL, HL ; *2
	ADD	HL, HL ; *4
	LD	B, H
	LD	C, L
	ADD	HL, HL ; *8
	LD	D, H
	LD	E, L
	ADD	HL, HL ; *16
	ADD	HL, BC
	ADD	HL, DE
	RET

; HL = HL * 40
; Break BC
MUL_HLx40:
	ADD	HL, HL ; *2
	ADD	HL, HL ; *4
	ADD	HL, HL ; *8
	LD	B, H
	LD	C, L
	ADD	HL, HL ; *16
	ADD	HL, HL ; *32
	ADD	HL, BC
	RET

; HL = HL * 80
; Break BC
MUL_HLx80:
	ADD	HL, HL ; *2
	ADD	HL, HL ; *4
	ADD	HL, HL ; *8
	ADD	HL, HL ; *16
	LD	B, H
	LD	C, L
	ADD	HL, HL ; *32
	ADD	HL, HL ; *64
	ADD	HL, BC
	RET

; HL = HL * 320
; Break BC
MUL_HLx320:
	ADD	HL, HL ; *2
	ADD	HL, HL ; *4
	ADD	HL, HL ; *8
	ADD	HL, HL ; *16
	ADD	HL, HL ; *32
	ADD	HL, HL ; *64
	LD	B, H
	LD	C, L
	ADD	HL, HL ; *128
	ADD	HL, HL ; *256
	ADD	HL, BC
	RET

; BC = HL / DE 小数点切り捨て, HL = あまり
DIV16:
	LD	BC, 0
	OR	A
DIV16_L1:
	SBC	HL, DE
	JR	C, DIV16_L2
	INC	BC
	JR	DIV16_L1
DIV16_L2:
	ADD	HL, DE
	RET

; A(0〜15)を(0〜F)に変換する
; Break HL
A_TO_HEX:
	LD	HL, HEX_TABLE
	CALL	ADD_HL_A
	LD	A, (HL)
	RET

; 一定時間待つ
DLY80U:	PUSH	DE	; 80マイクロ秒
	LD	DE, 13
	JP	DLYT
DLY1M:	PUSH	DE	; 1ミリ秒
	LD	DE, 130
	JP	DLYT
DLY60M:	PUSH	DE	; 60ミリ秒
	LD	DE, 6700
DLYT:	DEC	DE	; DE回ループする
	LD	A, E
	OR	D
	JR	NZ, DLYT
	POP	DE
	RET

; 0Dhで終わっている文字列を比較する
; LD	DE, 比較文字列1, 0Dh
; LD	HL, 比較文字列2, 0Dh
; Result Cyフラグ (0: 違う, 1: 同じ)
CMP_TEXT:
CMP_TEXT_1:
	LD	A, (DE)
	CP	(HL)
	JR	NZ, CMP_TEXT_2
	CP	00Dh
	INC	DE
	INC	HL
	JR	NZ, CMP_TEXT_1
	JR	CMP_TEXT_3
CMP_TEXT_2:
	OR	A
	RET
CMP_TEXT_3:
	SCF
	RET

; 0-255の乱数をAレジスタに返す
RAND:
	LD	A, 0
	LD	E, A
	ADD	A, A
	ADD	A, A
	ADD	A, E
	INC	A
	LD	(RAND + 1), A
	RET

; 0〜63の角度番号からX成分を取得する
; LD A, 方向 0〜63
; Result HL = 横成分
GET_DIR_X:
	LD	HL, DIR_X_TBL
GET_DIR_Y_SUB:
	ADD	A, A
	LD	B, 0
	LD	C, A
	ADD	HL, BC
	LD	C, (HL)
	INC	HL
	LD	B, (HL)
	RET

; 0〜63の角度番号からY成分を取得する
; LD A, 方向 0〜63
; Result BC = Y成分
GET_DIR_Y:
	LD	HL, DIR_Y_TBL
	JR	GET_DIR_Y_SUB

; 撃つ方向取得
; IX 自分
; IY 相手
; Result A = 方向(0〜63)
FIRE_DIR:
	PUSH	DE
	LD	A, (IY + 9) ; TargetY
	SRA	A ; 1/2
	LD	B, A
	LD	A, (IX + 9) ; Y
	SRA	A ; 1/2
	SUB	B
	JP	M, FIRE_DIR_L1
	LD	H, 0
	JR	FIRE_DIR_L2
FIRE_DIR_L1:
	LD	H, 0FFh
FIRE_DIR_L2:
	LD	L, A
	CALL	MUL_HLx28
	LD	A, (IY + 7) ; TargetX
	SRA	A ; 1/2
	LD	B, A
	LD	A, (IX + 7) ; X
	SRA	A ; 1/2
	SUB	B
	JP	M, FIRE_DIR_L3
	LD	B, 0
	JR	FIRE_DIR_L4
FIRE_DIR_L3:
	LD	B, 0FFh
FIRE_DIR_L4:
	LD	C, A
	ADD	HL, BC
	LD	DE, FIRE_DIR_TBL + 25 * 28 + 14
	EX	DE, HL
	ADD	HL, DE
	; A=撃つ方向
	LD	A, (HL)
	POP	DE
	RET

; 16進数変換用テーブル
HEX_TABLE:
	DB	"0123456789ABCDEF"

; 64方向テーブル
DIR_Y_TBL:
	DW	0, 38, 74, 111, 146, 180, 213, 243, 272, 296, 318, 338, 354, 366, 377, 381
DIR_X_TBL:
	DW	384, 381, 377, 366, 354, 338, 318, 296, 272, 243, 213, 180, 146, 111, 74, 38
	DW	0, -39, -75, -113, -147, -182, -215, -245, -273, -297, -320, -339, -356, -368, -378, -383
	DW	-384, -383, -378, -368, -356, -339, -320, -297, -273, -245, -215, -182, -147, -113, -75, -39
	DW	-2, 38, 74, 111, 146, 180, 213, 243, 272, 296, 318, 338, 354, 366, 377, 381

; (25,14)への方向テーブル 50x28
FIRE_DIR_TBL:
	DB	11, 11, 11, 12, 12, 12, 13, 13, 14, 14, 14, 15, 15, 16, 16, 16, 17, 17, 18, 18, 18, 19, 19, 20, 20, 20, 21, 21
	DB	11, 11, 11, 12, 12, 12, 13, 13, 14, 14, 14, 15, 15, 16, 16, 16, 17, 17, 18, 18, 18, 19, 19, 20, 20, 20, 21, 21
	DB	10, 11, 11, 11, 12, 12, 13, 13, 13, 14, 14, 15, 15, 16, 16, 16, 17, 17, 18, 18, 19, 19, 19, 20, 20, 21, 21, 21
	DB	10, 10, 11, 11, 12, 12, 12, 13, 13, 14, 14, 15, 15, 15, 16, 17, 17, 17, 18, 18, 19, 19, 20, 20, 20, 21, 21, 22
	DB	10, 10, 11, 11, 12, 12, 12, 13, 13, 14, 14, 15, 15, 15, 16, 17, 17, 17, 18, 18, 19, 19, 20, 20, 20, 21, 21, 22
	DB	10, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 14, 15, 15, 16, 17, 17, 18, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22
	DB	10, 10, 10, 11, 11, 12, 12, 12, 13, 13, 14, 14, 15, 15, 16, 17, 17, 18, 18, 19, 19, 20, 20, 20, 21, 21, 22, 22
	DB	9, 10, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22, 22
	DB	9, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21, 22, 22, 23
	DB	9, 9, 9, 10, 10, 11, 11, 12, 12, 13, 14, 14, 15, 15, 16, 17, 17, 18, 18, 19, 20, 20, 21, 21, 22, 22, 23, 23
	DB	8, 9, 9, 10, 10, 10, 11, 12, 12, 13, 13, 14, 15, 15, 16, 17, 17, 18, 19, 19, 20, 20, 21, 22, 22, 22, 23, 23
	DB	8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 14, 15, 15, 16, 17, 17, 18, 19, 20, 20, 21, 21, 22, 22, 23, 23, 24
	DB	8, 8, 8, 9, 9, 10, 10, 11, 12, 12, 13, 14, 14, 15, 16, 17, 18, 18, 19, 20, 20, 21, 22, 22, 23, 23, 24, 24
	DB	7, 8, 8, 8, 9, 9, 10, 11, 11, 12, 13, 14, 14, 15, 16, 17, 18, 18, 19, 20, 21, 21, 22, 23, 23, 24, 24, 24
	DB	7, 7, 8, 8, 9, 9, 10, 10, 11, 12, 12, 13, 14, 15, 16, 17, 18, 19, 20, 20, 21, 22, 22, 23, 23, 24, 24, 25
	DB	6, 7, 7, 7, 8, 9, 9, 10, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 22, 23, 23, 24, 25, 25, 25
	DB	6, 6, 7, 7, 7, 8, 9, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 23, 24, 25, 25, 25, 26
	DB	5, 6, 6, 6, 7, 7, 8, 9, 9, 10, 11, 12, 14, 15, 16, 17, 18, 20, 21, 22, 23, 23, 24, 25, 25, 26, 26, 26
	DB	5, 5, 5, 6, 6, 7, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 19, 20, 21, 22, 23, 24, 25, 25, 26, 26, 27, 27
	DB	4, 4, 5, 5, 6, 6, 7, 7, 8, 9, 10, 11, 13, 14, 16, 18, 19, 21, 22, 23, 24, 25, 25, 26, 26, 27, 27, 28
	DB	4, 4, 4, 4, 5, 5, 6, 6, 7, 8, 9, 10, 12, 14, 16, 18, 20, 22, 23, 24, 25, 26, 26, 27, 27, 28, 28, 28
	DB	3, 3, 3, 4, 4, 4, 5, 5, 6, 7, 8, 9, 11, 14, 16, 18, 21, 23, 24, 25, 26, 27, 27, 28, 28, 28, 29, 29
	DB	2, 2, 2, 3, 3, 3, 4, 4, 5, 6, 7, 8, 10, 13, 16, 19, 22, 24, 25, 26, 27, 28, 28, 29, 29, 29, 30, 30
	DB	1, 2, 2, 2, 2, 2, 2, 3, 3, 4, 5, 6, 8, 11, 16, 21, 24, 26, 27, 28, 29, 29, 30, 30, 30, 30, 30, 30
	DB	1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 3, 5, 8, 16, 24, 27, 29, 30, 30, 30, 31, 31, 31, 31, 31, 31, 31
	DB	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32
	DB	63, 63, 63, 63, 63, 63, 63, 63, 62, 62, 62, 61, 59, 56, 48, 40, 37, 35, 34, 34, 34, 33, 33, 33, 33, 33, 33, 33
	DB	63, 62, 62, 62, 62, 62, 62, 61, 61, 60, 59, 58, 56, 53, 48, 43, 40, 38, 37, 36, 35, 35, 34, 34, 34, 34, 34, 34
	DB	62, 62, 62, 61, 61, 61, 60, 60, 59, 58, 57, 56, 54, 51, 48, 45, 42, 40, 39, 38, 37, 36, 36, 35, 35, 35, 34, 34
	DB	61, 61, 61, 60, 60, 60, 59, 59, 58, 57, 56, 55, 53, 50, 48, 46, 43, 41, 40, 39, 38, 37, 37, 36, 36, 36, 35, 35
	DB	60, 60, 60, 60, 59, 59, 58, 58, 57, 56, 55, 54, 52, 50, 48, 46, 44, 42, 41, 40, 39, 38, 38, 37, 37, 36, 36, 36
	DB	60, 60, 59, 59, 58, 58, 57, 57, 56, 55, 54, 53, 51, 50, 48, 46, 45, 43, 42, 41, 40, 39, 39, 38, 38, 37, 37, 36
	DB	59, 59, 59, 58, 58, 57, 57, 56, 55, 54, 53, 52, 51, 49, 48, 47, 45, 44, 43, 42, 41, 40, 39, 39, 38, 38, 37, 37
	DB	59, 58, 58, 58, 57, 57, 56, 55, 55, 54, 53, 52, 50, 49, 48, 47, 46, 44, 43, 42, 41, 41, 40, 39, 39, 38, 38, 38
	DB	58, 58, 57, 57, 57, 56, 55, 55, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45, 44, 43, 42, 41, 41, 40, 39, 39, 39, 38
	DB	58, 57, 57, 57, 56, 55, 55, 54, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45, 44, 43, 42, 42, 41, 41, 40, 39, 39, 39
	DB	57, 57, 56, 56, 55, 55, 54, 54, 53, 52, 52, 51, 50, 49, 48, 47, 46, 45, 44, 44, 43, 42, 42, 41, 41, 40, 40, 39
	DB	57, 56, 56, 56, 55, 55, 54, 53, 53, 52, 51, 50, 50, 49, 48, 47, 46, 46, 45, 44, 43, 43, 42, 41, 41, 40, 40, 40
	DB	56, 56, 56, 55, 55, 54, 54, 53, 52, 52, 51, 50, 50, 49, 48, 47, 46, 46, 45, 44, 44, 43, 42, 42, 41, 41, 40, 40
	DB	56, 56, 55, 55, 54, 54, 53, 53, 52, 52, 51, 50, 49, 49, 48, 47, 47, 46, 45, 44, 44, 43, 43, 42, 42, 41, 41, 40
	DB	56, 55, 55, 54, 54, 54, 53, 52, 52, 51, 51, 50, 49, 49, 48, 47, 47, 46, 45, 45, 44, 44, 43, 42, 42, 42, 41, 41
	DB	55, 55, 55, 54, 54, 53, 53, 52, 52, 51, 50, 50, 49, 49, 48, 47, 47, 46, 46, 45, 44, 44, 43, 43, 42, 42, 41, 41
	DB	55, 55, 54, 54, 53, 53, 52, 52, 51, 51, 50, 50, 49, 49, 48, 47, 47, 46, 46, 45, 45, 44, 44, 43, 43, 42, 42, 41
	DB	55, 54, 54, 54, 53, 53, 52, 52, 51, 51, 50, 50, 49, 49, 48, 47, 47, 46, 46, 45, 45, 44, 44, 43, 43, 42, 42, 42
	DB	54, 54, 54, 53, 53, 52, 52, 52, 51, 51, 50, 50, 49, 49, 48, 47, 47, 46, 46, 45, 45, 44, 44, 44, 43, 43, 42, 42
	DB	54, 54, 54, 53, 53, 52, 52, 51, 51, 50, 50, 50, 49, 49, 48, 47, 47, 46, 46, 46, 45, 45, 44, 44, 43, 43, 42, 42
	DB	54, 54, 53, 53, 52, 52, 52, 51, 51, 50, 50, 49, 49, 49, 48, 47, 47, 47, 46, 46, 45, 45, 44, 44, 44, 43, 43, 42
	DB	54, 54, 53, 53, 52, 52, 52, 51, 51, 50, 50, 49, 49, 49, 48, 47, 47, 47, 46, 46, 45, 45, 44, 44, 44, 43, 43, 42
	DB	54, 53, 53, 53, 52, 52, 51, 51, 51, 50, 50, 49, 49, 48, 48, 48, 47, 47, 46, 46, 45, 45, 45, 44, 44, 43, 43, 43
	DB	53, 53, 53, 52, 52, 52, 51, 51, 50, 50, 50, 49, 49, 48, 48, 48, 47, 47, 46, 46, 46, 45, 45, 44, 44, 44, 43, 43
